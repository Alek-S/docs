<html>
<head>
<title>NodeDocs</title>
<script src="/dnode.js"></script>
<style>
li {
  padding-left:5px;
}
</style>
</head>
<body>
  <h1>List of articles:</h1>
  <div id="list-of-articles"></div><br />
  <h1>Contents of Article `<span id="current-article"></span>`:</h1>
  <div id="article"></div>
</body>
<script>
  window.onload = function () {
    var remote = null;
    loadArticle = function (article) {
      remote.getGuide(article, function (err, guide) {
        document.getElementById("current-article").innerHTML = article;
        if (err) {
          document.getElementById("article").innerHTML = err;
          return;
        }
        var article_ = guide.content;
        delete guide.content;
        document.getElementById("article").innerHTML = JSON.stringify(guide) +
          "<br /><br />" +article_.replace("\\n","<br />");
      });
    }

   var build_tree = function (articles, paths) {
      var tree = {};
      var temp = null;
      for (var i = 0; i < articles.length; ++i) {
        var keys = paths[i].split('/');
        temp = tree;
        for (var j = 1; j < keys.length; ++j) {
          if (j === keys.length-1) {
            temp[keys[j]] = articles[i];
          }
          if (temp[keys[j]] === undefined) {
            temp[keys[j]] = {};
          }
          temp = temp[keys[j]]
        }
      }
      return tree;
    }

    var render_tree = function (tree, depth) {
      if (depth === undefined) {
        depth = 0;
      }
      var str = ""
      for (key in tree){
        switch(typeof tree[key]) {
          case 'string':
            str += "<li><a href='#' onclick='loadArticle(\""+tree[key]+"\")'>"+tree[key]+"</a></li>";
            break;
          case 'object':
            var html = "h" + (depth+1) + ">";
            str +=  "<ul><"+html + key + "</"+html + render_tree(tree[key], depth+1) + "</ul>";
        }
      }
      return str;
    }

    DNode.connect(function (remote_) {
      remote = remote_;
      remote.getArticleList(function (err, articles, paths) {
        if (err) {
          document.getElementById("list-of-articles").innerHTML = err;
          return;
        }
        var tree = build_tree(articles, paths);
        document.getElementById("list-of-articles").innerHTML = render_tree(tree);
      });
    });
  }
</script>
</html>
